# Three.js 3D 扭蛋機抽獎專案任務清單

> **專案目標**：製作會動的 3D 扭蛋機，用於醫院春酒抽獎活動

## 在測試的時候要考量瀏覽器版本的問題

## 一、專案初始化

- [x] 初始化 Next.js 16 專案（App Router）
- [x] 安裝 TypeScript
- [x] 安裝 React Three Fiber 與 Drei
- [x] 安裝 Tailwind CSS 與 Shadcn UI
- [x] 安裝 Zustand 狀態管理
- [x] 建立 Git 倉庫與初始提交
- [x] 確認 Node.js 版本 >= 20

## 二、3D 扭蛋機場景建置

- [x] 建立 Scene.tsx 基礎場景
- [x] 加入 GLTF 扭蛋機模型（gacha.gltf）
- [x] 配置相機位置與 OrbitControls
- [x] 設置 HDR 環境照明（Environment）
- [x] 模型居中與縮放調整
- [ ] 測試模型在不同設備上的載入效能

## 三、扭蛋機動畫系統

- [x] 扭蛋機本體晃動動畫（已完成）- 多軸旋轉(Z/X軸) + Y軸位移,含平滑漸入漸出
- [x] 扭蛋彈跳與旋轉動畫（已完成）- 自動分組識別機內扭蛋,隨機彈跳與旋轉
- [x] 動畫播放/暫停控制（已完成）- 使用 Zustand store 管理
- [x] 建立金幣 3D 模型或物件（已完成）- Coin.tsx 組件,含正反面 $ 符號
- [x] 實作金幣投入動畫（從投幣口掉入）（已完成）- 下落 + 淡出效果
- [x] 加入動畫緩動效果（easing）（已完成）- easeInOutQuad 函數
- [x] 動畫序列流程控制（已完成）- 金幣投入 → 淡出 → 延遲 → 扭蛋機晃動 → 扭蛋彈跳
- [ ] 建立單顆扭蛋物件（用於掉落）
- [ ] 實作扭蛋掉落動畫（從出口滾出）
- [ ] 實作扭蛋打開動畫（開蓋或爆開效果）

## 四、狀態管理

- [x] 使用 Zustand 建立 store（已完成）- useAnimationStore.ts (isAnimating / setIsAnimating / toggleAnimation)
- [x] 將扭蛋機動畫與 store 狀態連動（已完成）- Scene.tsx 整合 Zustand
- [x] 處理動畫序列的時間控制（已完成）- 金幣下落 → 淡出 → 延遲 → 晃動序列
- [ ] 設計完整 LotteryPhase 狀態機（idle / coin_inserting / shaking / dropping / opening / revealing / done）
- [ ] 擴充 store 加入抽獎邏輯（phase / winner / startDraw / resetDraw）

## 五、抽獎流程與邏輯

### 完整抽獎流程（新需求）：
- [x] **Phase 1: 點擊開始按鈕** → 觸發抽獎流程（已完成）- 播放/暫停按鈕
- [x] **Phase 2: 金幣投入** (coin_inserting)（已完成）
  - [x] 生成金幣物件（Coin.tsx）
  - [x] 金幣從投幣口掉入扭蛋機（下落動畫 + 淡出效果）
- [x] **Phase 3: 扭蛋機晃動（抽獎環節）** (shaking)（已完成）
  - [x] 金幣淡出後,扭蛋機開始劇烈晃動（延遲 0.2 秒後啟動）
  - [ ] 呼叫 API 決定中獎者（背景執行）
  - [x] 晃動持續 5 秒
  - [x] 扭蛋在機器內部碰撞、彈跳（分組隨機彈跳與旋轉）
- [x] **Phase 4: 停止晃動**（已完成）
  - [x] 扭蛋機逐漸停止晃動（平滑漸出效果）
  - [x] 緩動效果（easeInOutQuad）
- [ ] **Phase 5: 扭蛋掉落** (dropping)
  - [ ] 單顆扭蛋從出口掉落
  - [ ] 扭蛋滾動/彈跳動畫
- [ ] **Phase 6: 扭蛋打開** (opening)
  - [ ] 扭蛋打開動畫（開蓋或爆開效果）
- [ ] **Phase 7: 顯示中獎者** (revealing)
  - [ ] 顯示中獎者姓名與部門（UI 彈窗或 3D 文字）
- [ ] **Phase 8: 完成** (done)
  - [ ] 顯示「下一輪」或「重新抽獎」按鈕

## 六、API 串接

- [ ] 設計 `/api/draw` 路由
- [ ] 回傳中獎者資料
- [ ] 前端抽獎流程整合 API
- [ ] 處理錯誤情況（API 失敗 / 重試 / 無人可抽）
- [ ] 實作防重複中獎邏輯（後端或前端）

## 七、UI / 控制面板

- [ ] 設計開始抽獎按鈕（固定在畫面上方或下方）
- [ ] 設計中獎者資訊顯示卡片
- [ ] 設計重播 / 下一輪按鈕
- [ ] 設計抽獎中 / 已完成狀態提示
- [ ] 行動裝置適配（RWD）
- [ ] 加入 Loading 提示（模型載入中）

## 八、音效與特效（選配）

- [ ] 加入扭蛋機音效（把手轉動、掉落、打開）
- [ ] 加入中獎音效與背景音樂
- [ ] 加入光影效果（聚光燈照在扭蛋上）
- [ ] 加入粒子效果（扭蛋打開時的彩帶或星星）
- [ ] 可選後製效果（Bloom / 光暈）

## 九、測試與部署

- [ ] 測試多瀏覽器兼容性（Chrome / Edge / Safari）
- [ ] 測試多設備兼容性（桌機 / 平板 / 手機）
- [ ] 測試 3D 模型載入效能（249k triangles）
- [ ] 修正動畫延遲與卡頓問題
- [ ] 部署至內網或可現場展示的環境
- [ ] 撰寫操作手冊（主持人使用）
- [ ] 準備備案方案（若 3D 載入失敗）

## 十、額外加分項目

- [ ] 記錄抽獎歷史與中獎名單
- [ ] 匯出中獎名單（CSV / Excel）
- [ ] UI 美化（醫院品牌色 / 春酒主題）
- [ ] 加入倒數計時動畫
---

---

## 📊 進度總結（2025-12-23 更新）

### ✅ 已完成功能
1. **基礎架構**
   - ✅ Next.js 16 + TypeScript + React Three Fiber 完整設置
   - ✅ Zustand 狀態管理整合
   - ✅ 3D 場景與模型加載系統

2. **動畫系統**
   - ✅ **金幣投入動畫** - 3D 金幣組件（Coin.tsx）含正反面 $ 符號
   - ✅ **金幣下落與淡出** - 從起始位置掉落至投幣口,到達消失點後淡出
   - ✅ **扭蛋機晃動** - 多軸旋轉（Z/X軸）+ Y軸位移,含平滑漸入漸出效果（5秒）
   - ✅ **扭蛋彈跳** - 自動分組識別機內扭蛋,施加隨機彈跳與旋轉動畫
   - ✅ **動畫序列控制** - 金幣投入 → 淡出 → 延遲 0.2 秒 → 晃動 → 扭蛋彈跳
   - ✅ **播放/暫停控制** - UI 按鈕整合 Zustand store
   - ✅ **緩動函數** - easeInOutQuad 確保動畫平滑自然

3. **視覺效果**
   - ✅ 相機開場動畫（環繞 + 距離過渡）
   - ✅ 3D 漂浮文字
   - ✅ HDR 環境照明
   - ✅ 加載進度系統

### 🚧 待完成功能（優先順序）

1. **立即執行**：分析扭蛋機模型結構,找出把手、扭蛋出口等可動部件
2. **把手旋轉**：實作把手旋轉動畫（在金幣投入後、晃動前觸發）
3. **扭蛋掉落**：建立單顆扭蛋物件 + 從出口掉落的動畫
4. **扭蛋打開**：實作扭蛋開蓋或爆開效果
5. **中獎顯示**：UI 彈窗或 3D 文字顯示中獎者資訊
6. **API 整合**：串接後端抽獎 API（在晃動階段背景呼叫）
7. **完整狀態機**：擴充 LotteryPhase 狀態管理（idle → coin_inserting → handle_turning → shaking → dropping → opening → revealing → done）
8. **UI 優化**：將「播放」按鈕改為「開始抽獎」,加入重置/下一輪功能

### 📈 整體進度
- 專案初始化與架構：100% ✅
- 3D 場景與模型：100% ✅
- 動畫系統核心：約 70% ✅（已完成金幣投入、晃動、扭蛋彈跳）
- 狀態管理：約 50% 🚧（基礎 store 完成,待擴充完整狀態機）
- 抽獎流程：約 40% 🚧（Phase 1-5 已完成,待完成 Phase 6-9）
- API 串接：0% ⏳
- UI/控制面板：約 30% 🚧（基礎按鈕完成,待擴充完整 UI）

---

## 下一步建議

1. **立即執行**：分析扭蛋機模型結構,找出把手、扭蛋出口等可動部件
2. **把手旋轉**：實作把手旋轉動畫（插入金幣投入與晃動之間）
3. **扭蛋掉落**：完成單顆扭蛋掉落 + 打開動畫
4. **狀態管理**：擴充 Zustand 建立完整的抽獎流程狀態機
5. **基礎 UI**：修改現有的播放/暫停按鈕為「開始抽獎」按鈕
6. **API 整合**：設計並串接後端抽獎 API
7. **整合測試**：完整流程測試（點擊開始 → 金幣投入 → 把手旋轉 → 晃動 → 掉落 → 打開 → 顯示結果）
