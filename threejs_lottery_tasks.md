# Three.js 3D 扭蛋機抽獎專案任務清單

> **專案目標**：製作會動的 3D 扭蛋機，用於醫院春酒抽獎活動

## 在測試的時候要考量瀏覽器版本的問題

## 一、專案初始化

- [x] 初始化 Next.js 16 專案（App Router）
- [x] 安裝 TypeScript
- [x] 安裝 React Three Fiber 與 Drei
- [x] 安裝 Tailwind CSS 與 Shadcn UI
- [x] 安裝 Zustand 狀態管理
- [x] 建立 Git 倉庫與初始提交
- [x] 確認 Node.js 版本 >= 20

## 二、3D 扭蛋機場景建置

- [x] 建立 Scene.tsx 基礎場景
- [x] 加入 GLTF 扭蛋機模型（gacha.gltf）
- [x] 配置相機位置與 OrbitControls
- [x] 設置 HDR 環境照明（Environment）
- [x] 模型居中與縮放調整

## 三、扭蛋機動畫系統

- [x] 扭蛋機本體晃動動畫（已完成）- 多軸旋轉(Z/X 軸) + Y 軸位移,含平滑漸入漸出
- [x] 扭蛋彈跳與旋轉動畫（已完成）- 自動分組識別機內扭蛋,隨機彈跳與旋轉
- [x] 動畫播放/暫停控制（已完成）- 使用 Zustand store 管理
- [x] 建立金幣 3D 模型或物件（已完成）- Coin.tsx 組件,含正反面 $ 符號
- [x] 實作金幣投入動畫（從投幣口掉入）（已完成）- 下落 + 淡出效果
- [x] 加入動畫緩動效果（easing）（已完成）- easeInOutQuad 函數
- [x] 動畫序列流程控制（已完成）- 金幣投入 → 淡出 → 延遲 → 扭蛋機晃動 → 扭蛋彈跳
- [x] 建立單顆扭蛋物件（用於掉落）
- [x] 實作扭蛋掉落動畫（從出口滾出）

## 四、狀態管理

- [x] 使用 Zustand 建立 store（已完成）- useAnimationStore.ts (isAnimating / setIsAnimating / toggleAnimation)
- [x] 將扭蛋機動畫與 store 狀態連動（已完成）- Scene.tsx 整合 Zustand
- [x] 處理動畫序列的時間控制（已完成）- 金幣下落 → 淡出 → 延遲 → 晃動序列

## 五、抽獎流程與邏輯

### 完整抽獎流程（新需求）：

- [x] **Phase 1: 點擊開始按鈕** → 觸發抽獎流程（已完成）- 播放/暫停按鈕
- [x] **Phase 2: 金幣投入** (coin_inserting)（已完成）
  - [x] 生成金幣物件（Coin.tsx）
  - [x] 金幣從投幣口掉入扭蛋機（下落動畫 + 淡出效果）
- [x] **Phase 3: 扭蛋機晃動（抽獎環節）** (shaking)（已完成）
  - [x] 金幣淡出後,扭蛋機開始劇烈晃動（延遲 0.2 秒後啟動）
  - [ ] 呼叫 API 決定中獎者（背景執行）
  - [x] 晃動持續 5 秒
  - [x] 扭蛋在機器內部碰撞、彈跳（分組隨機彈跳與旋轉）
- [x] **Phase 4: 停止晃動**（已完成）
  - [x] 扭蛋機逐漸停止晃動（平滑漸出效果）
  - [x] 緩動效果（easeInOutQuad）
- [x] **Phase 5: 扭蛋掉落** (dropping)
  - [x] 單顆扭蛋從出口掉落
  - [x] 扭蛋滾動/彈跳動畫
- [x] **Phase 6: 顯示中獎者** (revealing)
  - [x] 顯示中獎者姓名與部門（UI 彈窗或 3D 文字）
- [x] **Phase 7: 完成** (done)
  - [x] 顯示「下一輪」或「重新抽獎」按鈕

## 六、測試與部署

- [ ] 測試多瀏覽器兼容性（Chrome / Edge / Safari）
- [ ] 測試多設備兼容性（桌機 / 平板 / 手機）
- [ ] 測試 3D 模型載入效能（249k triangles）
- [ ] 修正動畫延遲與卡頓問題
- [ ] 部署至內網或可現場展示的環境
- [ ] 撰寫操作手冊（主持人使用）
- [ ] 準備備案方案（若 3D 載入失敗）

## 七、資料管理與抽獎規則系統

### 7.1 參與者名單管理（已完成）

- [x] 新增 TXT 檔案上傳功能
  - [x] 支援 UTF-8 編碼文本檔案
  - [x] 解析每行一個參與者的格式
  - [x] 檔案驗證與錯誤處理
- [x] 建立參與者資料結構
  - [x] 設計 Participant 介面（姓名、員工編號、部門等）
  - [x] 建立參與者列表狀態管理
  - [x] 實作新增/刪除/編輯參與者功能
- [x] 參與者名單 UI
  - [x] 檔案上傳按鈕與拖放區域
  - [x] 參與者列表顯示（含總人數統計）
  - [x] 手動新增參與者表單
  - [x] 匯入範例資料功能（sample-participants.txt）

### 7.2 獎項設定系統（已完成）

- [x] 定義獎項資料結構
  - [x] 設計 Prize 介面（獎項名稱、等級、數量、描述等）
  - [x] 建立獎項列表狀態管理
- [x] 獎項設定功能
  - [x] 新增/編輯/刪除獎項
  - [x] 設定每個獎項的中獎人數
  - [x] 獎項排序與優先級設定（頭獎、二獎、三獎等）
- [x] 獎項設定 UI
  - [x] 獎項管理面板
  - [x] 獎項表單（名稱、數量、等級）
  - [x] 獎項預覽與統計（總獎項數、總中獎人數）
- [x] 獎項與抽獎流程整合
  - [x] 根據獎項設定執行抽獎邏輯（useLotteryLogic hook）
  - [x] 顯示當前抽取的獎項資訊（中獎彈窗）
  - [x] 自動使用等級最小的獎項進行配對

### 7.3 資料持久化（已完成）

- [x] Zustand 持久化設定
  - [x] 安裝並配置 zustand/middleware (persist)
  - [x] 設定 localStorage 持久化
  - [x] 定義需要持久化的狀態（中獎紀錄、參與者名單、獎項設定）
- [x] 資料結構設計
  - [x] 中獎紀錄結構（中獎者、獎項、時間戳記）
  - [x] 參與者名單結構
  - [x] 獎項設定結構
- [x] 資料管理功能
  - [x] 清除歷史紀錄
  - [x] 匯出資料（JSON 格式）- 透過 persist middleware 自動處理

### 7.4 防重複中獎機制（已完成）

- [x] 中獎者追蹤系統
  - [x] 記錄所有歷史中獎者
  - [x] 建立已中獎者查詢功能（useLotteryLogic hook）
- [x] 抽獎前驗證
  - [x] 檢查剩餘可抽獎人數
  - [x] 驗證剩餘人數 >= 本次抽獎所需人數
  - [x] 顯示警告訊息（人數不足時）
- [x] 跳過已中獎者邏輯
  - [x] 實作「跳過已中獎者」選項（drawSingleWinner({ skipWinners: true })）
  - [x] 從參與者名單中過濾已中獎者
  - [x] UI 切換開關（啟用/停用防重複中獎）
- [x] 重複中獎規則設定
  - [x] 設定是否允許重複中獎（透過 skipWinners 參數控制）

### 7.5 資料匯出功能（已完成）

- [x] CSV 匯出
  - [x] 匯出中獎名單（含姓名、員工編號、獎項、時間）

### 7.6 管理介面整合（已完成）

- [x] 建立管理彈窗元件（ManagementModal.tsx）
  - [x] 分頁式介面設計（參與者/獎項/設定/紀錄）
  - [x] 整合所有管理功能於單一彈窗
- [x] 整合至 Gacha 頁面
  - [x] 在抽獎頁面加入「管理」按鈕
  - [x] 彈窗 z-index 層級管理
  - [x] 公開透明的管理介面
- [x] 中獎彈窗優化
  - [x] 顯示中獎者姓名
  - [x] 顯示員工編號（選填）
  - [x] 顯示部門（選填）
  - [x] 顯示獎項名稱
- [x] 3D 動畫與抽獎邏輯整合
  - [x] 使用 useLotteryLogic hook 進行真實抽獎
  - [x] 自動防重複中獎（skipWinners: true）
  - [x] 錯誤處理（無參與者、人數不足等）
  - [x] 中獎資料自動記錄與持久化

---

## 📊 專案完成度總覽（2025-12-25 更新）

### ✅ 已完成核心功能（100%）

#### 1. 3D 扭蛋機場景與動畫系統

- ✅ 完整的抽獎動畫流程（金幣投入 → 晃動 → 扭蛋掉落 → 浮起 → 中獎顯示）
- ✅ 物理引擎整合（@react-three/rapier）
- ✅ 相機動畫、環境光照、模型載入

#### 2. 資料管理系統

- ✅ 參與者名單管理（TXT 上傳、手動新增、編輯、刪除）
- ✅ 獎項設定系統（多獎項管理、等級排序）
- ✅ 中獎紀錄追蹤（完整歷史記錄）
- ✅ 資料持久化（localStorage + Zustand persist）

#### 3. 抽獎邏輯系統

- ✅ 真實隨機抽獎演算法（Fisher-Yates）
- ✅ 防重複中獎機制
- ✅ 人數驗證與錯誤處理
- ✅ 統計資訊顯示

#### 4. 使用者介面

- ✅ 管理彈窗（分頁式設計）
- ✅ 中獎彈窗（含員工編號、部門）
- ✅ 中獎紀錄面板（WinnerRecordBoard）
- ✅ CSV 匯出功能

---

## 🎯 核心功能已完成，可用於實際抽獎活動！

目前系統已具備完整的抽獎功能：

1. ✅ 上傳參與者名單（TXT 檔案或手動新增）
2. ✅ 設定獎項（名稱、等級、數量）
3. ✅ 執行抽獎（3D 動畫 + 真實隨機抽獎）
4. ✅ 防重複中獎（自動過濾已中獎者）
5. ✅ 顯示結果（中獎彈窗含完整資訊）
6. ✅ 記錄保存（localStorage 持久化）
7. ✅ 匯出名單（CSV 格式）

**建議接下來進行：實際測試 → 效能優化 → 部署準備**
